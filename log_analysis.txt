/*Log analysis assignment*/


/*creating popular_articles view*/
create view pop_article as 
select substring (path from 10) as path, count(id) as views
from log
group by path
order by views desc;

create view popular_articles as select articles.title, pop_article.views
from articles join pop_article
on articles.slug=pop_article.path
order by pop_article.views desc;

select * from popular_articles limit 3;

 title                | views  
------------------------------------+--------
 Candidate is jerk, alleges rival   | 338647
 Bears love berries, alleges bear   | 253801
 Bad things gone, say good people   | 170098
(3 rows)




/*creating author_works view*/
create view author_works as select articles.title, authors.name from articles join authors on articles.author = authors.id;

select author_works.name, sum(popular_articles.views) as total_views from author_works join popular_articles on author_works.title=popular_articles.title group by author_works.name order by total_views desc;

name          | total_views 
------------------------+-------------
 Ursula La Multa        |      507594
 Rudolf von Treppenwitz |      423457
 Anonymous Contributor  |      170098
 Markoff Chaney         |       84557
(4 rows)



/*creating error_data view*/
create view failed as select count(status) as failed_attempts, date(time) as day from log where status != '200 OK' group by day;

create view total as select count(status) as total_attempts, date(time) as day from log group by day;

create view error_table as select total.day, total.total_attempts, failed.failed_attempts from total left join failed on total.day=failed.day;

select day, (cast(failed_attempts as float)/cast(total_attempts as float)) as error from error_table order by error desc limit 5;

   day     |        error        
------------+---------------------
 2016-07-17 |   0.022785265049416
 2016-07-24 | 0.00774106589923864
 2016-07-19 | 0.00762834417932032
 2016-07-05 | 0.00760061242344707
 2016-07-08 | 0.00759980411006113





